<!DOCTYPE html>
<html>
<head>
    <script src="http://code.createjs.com/createjs-2013.12.12.min.js"> </script>
    <script src="/loadxmldoc.js" ></script>
    <script>
        var stage; 
        var queue;
        var map;
        var guy;
        var currentFrame;
        var time;
        var isAttack;
        
        function init() {
            stage = new createjs.Stage("demoCanvas");
            queue = new createjs.LoadQueue(false);
            map = parsedTexturePackerMap();
            queue.installPlugin(createjs.Sound);
            queue.addEventListener("complete", handleComplete);
            queue.loadManifest([{id:"sprites",src:"img/A1textures.png"},{id:"sound", src:"img/VEC2 Bass 007 A.mp3"}]);
        }
        
        function tick(event){
            if(isAttack){
            var frameTime = 100;
            var sequence = ["Avatar1 -aggattack -1",
                            "Avatar1 -aggattack -2",
                            "Avatar1 -aggattack -3",
                            "Avatar1 -aggattack -4",
                            "Avatar1 -aggattack -5",
                            "Avatar1 -aggattack -6"];  
            time += event.delta;
            if(time>frameTime){
                if (currentFrame == 5){
                    currentFrame=0; 
                    time=0;
                    isAttack=false;
                }
                else{
                    currentFrame++;
                    time=0;
                }
               
            }
            guy.sourceRect=map[sequence[currentFrame]];
            }
            else{
                guy.sourceRect=map["Avatar1 -normstance"];
            }

            stage.update();
        }
        
        function handleComplete(event){
            var rect = map["Avatar1 -normstance"];
            guy = new createjs.Bitmap(queue.getResult("sprites"));
            guy.sourceRect=rect;
            guy.x = 100;
            guy.y = 100;
            guy.addEventListener("click", doAction)
            currentFrame =0;
            time=0;

        
            createjs.Ticker.addEventListener("tick", tick);
            

            stage.addChild(guy);
        }
        
        function doAction(event){
            isAttack = true;
        }

        function parsedTexturePackerMap(){
              var assArray = {};
              var xmlDoc = loadXMLDoc("/img/A1textures.xml");
              var frames=xmlDoc.getElementsByTagName("sprite");
              var j = 0;
              for (var i = 0; i < frames.length; i++)
              {
                var frame = frames[i].attributes;
                // Access each of the data values and construct the sourceRect.
                var Name = frame.getNamedItem("n").nodeValue;
                var x = frame.getNamedItem("x").nodeValue;
                var y = frame.getNamedItem("y").nodeValue;
                var w = frame.getNamedItem("w").nodeValue;
                var h = frame.getNamedItem("h").nodeValue;
                var rect = new createjs.Rectangle(x,y,w,h);
                assArray[Name] = rect;
              }
              return assArray;
        }
        
    </script>
</head>
<body onLoad="init();">
    <canvas id="fightCanvas" width="800" height="600">
        alternate content
    </canvas>
</body>
</html>